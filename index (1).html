<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTRY TACTICAL | v9.3 SERIAL BRIDGE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff003c;
            --neon-green: #00ff41;
            --bg-color: #050a10;
        }

        body {
            background-color: var(--bg-color);
            color: var(--neon-blue);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
            height: 100vh;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .header-font { font-family: 'Black Ops One', cursive; }

        .cyber-card {
            background: rgba(10, 20, 30, 0.9);
            border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .cyber-card::before { content: ''; position: absolute; top: 0; left: 0; width: 10px; height: 10px; border-top: 2px solid var(--neon-blue); border-left: 2px solid var(--neon-blue); }
        .cyber-card::after { content: ''; position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; border-bottom: 2px solid var(--neon-blue); border-right: 2px solid var(--neon-blue); }

        .breach-alert { animation: red-strobe 0.5s infinite; border-color: var(--neon-red) !important; box-shadow: 0 0 80px var(--neon-red) !important; }
        @keyframes red-strobe { 0%, 100% { background: rgba(50, 0, 0, 0.8); } 50% { background: rgba(100, 0, 0, 0.9); } }

        .radar {
            width: 100%; height: 100%; border-radius: 50%; border: 1px dashed rgba(0, 243, 255, 0.3); position: relative;
        }
        .radar::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 50%; height: 50%;
            background: linear-gradient(45deg, transparent 50%, rgba(0, 243, 255, 0.5) 100%);
            border-radius: 100% 0 0 0; transform-origin: 0 0; animation: radar-spin 3s linear infinite;
        }
        @keyframes radar-spin { 100% { transform: rotate(360deg); } }

        .btn-cy {
            background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue);
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 2px; cursor: pointer;
        }
        .btn-cy:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 25px var(--neon-blue); }
        
        .btn-red { border-color: var(--neon-red); color: var(--neon-red); background: rgba(255, 0, 60, 0.1); }
        .btn-red:hover { background: var(--neon-red); color: #fff; box-shadow: 0 0 30px var(--neon-red); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="flex flex-col">

    <!-- INIT OVERLAY -->
    <div id="init-screen" class="fixed inset-0 bg-[#020408] z-[9999] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-32 h-32 border-2 border-[#00f3ff] rounded-full flex items-center justify-center mb-6 animate-pulse">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#00f3ff" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        </div>
        <h1 class="header-font text-6xl text-white mb-2">OMNI<span class="text-[#00f3ff]">COMMAND</span></h1>
        <p class="text-[#00f3ff] mb-12 tracking-[5px] text-xs">V9.3 // SERIAL BRIDGE</p>
        <button onclick="bootSystem()" class="btn-cy py-4 px-10 rounded text-lg font-bold">INITIALIZE SYSTEM</button>
    </div>

    <!-- HEADER -->
    <header class="h-24 border-b border-[#00f3ff33] flex items-center justify-between px-6 bg-[#050a10f0] backdrop-blur-md z-50">
        <div class="flex items-center gap-4">
            <div id="status-led" class="w-4 h-4 bg-red-500 rounded-full shadow-[0_0_15px_red] transition-all duration-500"></div>
            <div>
                <h2 class="header-font text-3xl text-white leading-none">SENTRY<span class="text-[#00f3ff]">HUB</span></h2>
                <div class="text-[9px] text-gray-500 tracking-widest">STATUS: <span id="conn-status">DISCONNECTED</span></div>
            </div>
        </div>

        <div class="flex gap-4">
            <button onclick="toggleDemo()" id="demo-btn" class="btn-cy px-6 py-2 text-xs border-yellow-500 text-yellow-500 hover:bg-yellow-500">DEMO: OFF</button>
            <button onclick="connectPort()" id="link-btn" class="btn-cy px-8 py-3 text-sm font-bold bg-[#00f3ff11]">LINK WIRELESS</button>
        </div>
    </header>

    <!-- DASHBOARD -->
    <main class="flex-1 p-6 grid grid-cols-1 lg:grid-cols-4 gap-6 overflow-hidden">
        
        <!-- SIDEBAR -->
        <div class="col-span-1 flex flex-col gap-6">
            <div class="cyber-card p-6 flex flex-col gap-4">
                <h3 class="text-xs font-bold tracking-widest text-white border-b border-[#00f3ff33] pb-2">AUDIO PROTOCOL</h3>
                <div class="bg-black/40 p-4 border border-[#00f3ff22]">
                    <div class="text-[9px] text-gray-400 mb-1">ACTIVE TRACK</div>
                    <div id="track-name" class="text-xs text-[#00f3ff] truncate font-bold">Default_Siren.mp3</div>
                </div>
                <input type="file" id="audio-file" class="hidden" accept="audio/*" onchange="uploadAudio(this)">
                <button onclick="document.getElementById('audio-file').click()" class="btn-cy py-4 text-xs w-full">UPLOAD ASSET</button>
                <button onclick="testAudio()" class="btn-cy py-3 text-xs w-full border-gray-600 text-gray-400 hover:bg-gray-700">TEST SOUND</button>
            </div>
            
            <div class="cyber-card p-6 flex-1">
                 <h3 class="text-xs font-bold tracking-widest text-white border-b border-[#00f3ff33] pb-2 mb-4">DIAGNOSTICS</h3>
                 <div class="space-y-6">
                     <div>
                         <div class="flex justify-between text-[10px] mb-1"><span>PACKET STREAM</span><span id="pkt-count" class="text-[#00f3ff]">0</span></div>
                         <div class="h-1 bg-gray-800"><div id="pkt-bar" class="h-full bg-[#00f3ff] w-0 transition-all"></div></div>
                     </div>
                     <div>
                         <div class="flex justify-between text-[10px] mb-1"><span>SIGNAL INTEGRITY</span><span id="sig-val" class="text-emerald-500">---</span></div>
                         <div class="h-1 bg-gray-800"><div id="sig-bar" class="h-full bg-emerald-500 w-0 transition-all"></div></div>
                     </div>
                 </div>
            </div>
        </div>
        <!-- HUD -->
        <div class="col-span-1 lg:col-span-2 flex flex-col gap-6">
            <div id="main-display" class="cyber-card flex-1 flex flex-col items-center justify-center relative p-10 overflow-hidden transition-all duration-300">
                <div id="radar-container" class="absolute inset-0 opacity-30 pointer-events-none">
                    <div class="radar w-[500px] h-[500px] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
                </div>
                
                <div class="mb-8 p-8 border border-[#00f3ff44] rounded-full bg-[#00f3ff11]">
                     <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#00f3ff" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>

                <h1 id="status-text" class="header-font text-8xl text-white tracking-tighter mb-4 text-center leading-none">STANDBY</h1>
                <p id="sub-status" class="text-[#00f3ff] tracking-[5px] text-xs mb-12">SYSTEM AWAITING COMMAND</p>
                <button id="arm-btn" onclick="toggleArm()" class="btn-cy py-5 px-16 text-xl font-bold shadow-[0_0_40px_rgba(0,243,255,0.2)]">ENGAGE PERIMETER</button>
            </div>
            
            <div class="cyber-card p-6 h-40 relative">
                <div class="absolute top-3 left-5 text-[9px] text-[#00f3ff88]">LIVE TELEMETRY</div>
                <div class="absolute top-3 right-5 text-2xl font-bold font-mono text-[#00f3ff]" id="raw-val">0000</div>
                <canvas id="scope" class="w-full h-full pt-4"></canvas>
            </div>
        </div>

        <!-- LOGS -->
        <div class="col-span-1 cyber-card flex flex-col overflow-hidden">
            <div class="p-4 border-b border-[#00f3ff33] flex justify-between items-center bg-[#00f3ff05]">
                <h3 class="text-xs font-bold tracking-widest text-white">TACTICAL LOG</h3>
                <button onclick="clearLogs()" class="text-[9px] text-gray-500 hover:text-white">FLUSH</button>
            </div>
            <div id="logs" class="flex-1 overflow-y-auto p-4 space-y-3 font-mono text-[11px] custom-scrollbar">
                <div class="text-gray-600 italic">> Kernel loaded...</div>
            </div>
        </div>
    </main>
    <script>
        let armed = false, demo = false, port, reader;
        let alarm = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
        let dataHistory = new Array(100).fill(0);
        let packets = 0;
        
        const els = {
            statusText: document.getElementById('status-text'),
            subStatus: document.getElementById('sub-status'),
            armBtn: document.getElementById('arm-btn'),
            mainDisplay: document.getElementById('main-display'),
            logs: document.getElementById('logs'),
            rawVal: document.getElementById('raw-val'),
            canvas: document.getElementById('scope'),
            led: document.getElementById('status-led'),
            connStatus: document.getElementById('conn-status')
        };
        const ctx = els.canvas.getContext('2d');

        function bootSystem() {
            document.getElementById('init-screen').style.display = 'none';
            alarm.play().then(() => { alarm.pause(); alarm.currentTime = 0; }).catch(()=>{});
            addLog("SYSTEM ONLINE", "SUCCESS");
            requestAnimationFrame(drawLoop);
        }

        // --- UNIVERSAL SERIAL LINK (WORKS FOR BT COM PORTS) ---
        async function connectPort() {
            try {
                // Request Serial Port (User selects the Bluetooth COM port)
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                document.getElementById('link-btn').innerText = "LINKED";
                document.getElementById('link-btn').style.borderColor = "#00ff41";
                document.getElementById('link-btn').style.color = "#00ff41";
                els.led.style.backgroundColor = "#00ff41";
                els.led.style.boxShadow = "0 0 15px #00ff41";
                els.connStatus.innerText = "ONLINE";
                els.connStatus.style.color = "#00ff41";
                
                demo = false;
                addLog("HARDWARE LINK ESTABLISHED", "SUCCESS");
                readLoop();
            } catch (err) {
                addLog("LINK FAILED: " + err.message, "ERROR");
                alert("Tip: Select the 'Standard Serial over Bluetooth' COM port.");
            }
        }
        async function readLoop() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            let buffer = "";

            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        buffer += value;
                        // Process complete lines only
                        const lines = buffer.split("\n");
                        buffer = lines.pop(); // Keep incomplete chunk

                        for (const line of lines) {
                            handleDataLine(line.trim());
                        }
                    }
                }
            } catch (e) {
                addLog("CONNECTION LOST", "ERROR");
            }
        }

        function handleDataLine(line) {
            packets++;
            document.getElementById('pkt-count').innerText = packets;
            document.getElementById('pkt-bar').style.width = (packets % 100) + "%";

            // Update Telemetry
            const valMatch = line.match(/\[VAL:(\d+)\]/);
            if (valMatch) {
                const num = parseInt(valMatch[1]);
                updateGraph(num);
                document.getElementById('sig-val').innerText = "OPTIMAL";
                document.getElementById('sig-bar').style.width = "100%";
            }
            // Trigger Alarm
            if (line.includes("INTRUSION") && armed) {
                triggerAlarm();
            }
        }

        // --- CORE LOGIC ---
        function toggleArm() {
            if (els.statusText.innerText === "BREACH") {
                resetSystem(); return;
            }
            armed = !armed;
            if (armed) {
                updateUI("ARMED", "SCANNING PERIMETER", "#00f3ff");
                els.armBtn.innerText = "DISARM";
                addLog("GRID ENGAGED", "INFO");
            } else {
                updateUI("STANDBY", "AWAITING INPUT", "white");
                els.armBtn.innerText = "ENGAGE SYSTEM";
                addLog("GRID DISARMED", "INFO");
            }
        }

        function triggerAlarm() {
            if (els.statusText.innerText === "BREACH") return;
            updateUI("BREACH", "INTRUSION DETECTED", "#ff003c");
            els.mainDisplay.classList.add('breach-alert');
            els.armBtn.innerText = "RESET ALARM";
            els.armBtn.className = "btn-red py-4 px-12 text-lg font-bold";
            alarm.loop = true;
            alarm.play();
            addLog("CRITICAL BREACH DETECTED", "ERROR");
        }

        function resetSystem() {
            alarm.pause(); alarm.currentTime = 0;
            els.mainDisplay.classList.remove('breach-alert');
            els.armBtn.className = "btn-cy py-4 px-12 text-lg font-bold";
            armed = true; // Reset to armed
            updateUI("ARMED", "SCANNING PERIMETER", "#00f3ff");
            els.armBtn.innerText = "DISARM";
            addLog("ALARM CLEARED", "SUCCESS");
        }

        function updateUI(main, sub, color) {
            els.statusText.innerText = main;
            els.statusText.style.color = color;
            els.subStatus.innerText = sub;
            els.mainDisplay.style.borderColor = color === "white" ? "rgba(0,243,255,0.2)" : color;
        }

        // --- UTILS ---
        function updateGraph(val) {
            els.rawVal.innerText = val.toString().padStart(4, '0');
            dataHistory.push(val);
            dataHistory.shift();
        }

        function toggleDemo() {
            demo = !demo;
            const btn = document.getElementById('demo-btn');
            if (demo) {
                btn.innerText = "DEMO: ON";
                btn.style.color = "yellow";
                addLog("SIMULATION STARTED", "WARN");
                simulate();
            } else {
                btn.innerText = "DEMO: OFF";
                btn.style.color = "var(--neon-blue)";
                addLog("SIMULATION STOPPED", "INFO");
            }
        }

        function simulate() {
            if (!demo) return;
            const val = 900 + Math.floor(Math.random() * 100);
            updateGraph(val);
            if (armed && Math.random() > 0.98) triggerAlarm();
            setTimeout(simulate, 100);
        }

        function drawLoop() {
            const w = els.canvas.width = els.canvas.parentElement.offsetWidth;
            const h = els.canvas.height = els.canvas.parentElement.offsetHeight;
            ctx.clearRect(0, 0, w, h);
            ctx.strokeStyle = armed ? (els.statusText.innerText === "BREACH" ? "#ff003c" : "#00f3ff") : "#333";
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < dataHistory.length; i++) {
                const x = (i / dataHistory.length) * w;
                const y = h - ((dataHistory[i] / 1024) * h);
                if (i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
            requestAnimationFrame(drawLoop);
        }

        function uploadAudio(input) {
            const file = input.files[0];
            if (file) {
                alarm.src = URL.createObjectURL(file);
                document.getElementById('track-name').innerText = file.name;
                addLog("AUDIO UPLOADED: " + file.name, "SUCCESS");
                testAudio();
            }
        }
        function testAudio() {
            alarm.currentTime = 0;
            alarm.play();
            setTimeout(() => alarm.pause(), 2000);
            addLog("AUDIO DRIVER TESTED", "INFO");
        }

        function addLog(msg, type) {
            const d = document.createElement('div');
            const color = type === "ERROR" ? "text-[#ff003c]" : type === "SUCCESS" ? "text-[#00ff41]" : "text-[#00f3ff]";
            d.innerHTML = `<span class="text-gray-500">[${new Date().toLocaleTimeString()}]</span> <span class="${color}">> ${msg}</span>`;
            els.logs.prepend(d);
        }
        
        function clearLogs() { els.logs.innerHTML = ''; }
    </script>
</body>
</html>
